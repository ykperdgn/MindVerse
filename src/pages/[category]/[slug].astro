---
import Layout from '../../components/Layout.astro';
import CTASection from '../../components/CTASection.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const categories = ['health', 'love', 'history', 'psychology', 'space', 'quotes'];
  const paths = [];

  for (const category of categories) {
    try {
      const posts = await getCollection(category);
      for (const post of posts) {
        // Sadece ge√ßerli slug'ƒ± olan postlarƒ± dahil et
        if (post.slug && post.slug.trim() !== '') {
          paths.push({
            params: { category, slug: post.slug },
            props: { post }
          });
        }
      }
    } catch (error) {
      console.warn(`Error loading category ${category}:`, error);
    }
  }

  return paths;
}

const { category, slug } = Astro.params;
const { post } = Astro.props;

// Render the content
const { Content } = await post.render();
---

<Layout title={post.data.title}>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <!-- Article Header -->
    <header class="article-header">
      <div class="mb-4">
        <span class="bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full capitalize">
          {category}
        </span>
      </div>
      <h1 class="article-title">{post.data.title}</h1>
      <div class="article-meta">
        <span>
          üìÖ {new Date(post.data.date).toLocaleDateString('tr-TR')}
        </span>
        <span>
          üëÅÔ∏è {post.data.views || 0} g√∂r√ºnt√ºlenme
        </span>
        <span id="read-time">
          ‚è±Ô∏è ~3 dakika okuma
        </span>
      </div>
      {post.data.summary && (
        <p class="text-xl text-gray-600 leading-relaxed mt-4 font-light italic">
          {post.data.summary}
        </p>
      )}
      {post.data.tags && post.data.tags.length > 0 && (
        <div class="flex flex-wrap gap-2 mt-4">
          {post.data.tags.map(tag => (
            <span class="bg-gray-100 text-gray-700 text-xs px-3 py-1 rounded-full hover:bg-gray-200 transition-colors">
              #{tag}
            </span>
          ))}
        </div>
      )}
    </header><!-- AdSense reklam alanƒ± -->
    <div class="flex justify-center mb-8">
      <ins class="adsbygoogle"
        style="display: block"
        data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
        data-ad-slot="1234567890"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    <!-- CTA B√∂l√ºm√º -->
    <CTASection />

    <!-- Benzer ƒ∞√ßerikler -->
    <RelatedPosts
      currentSlug={post.slug}
      currentCategory={category}
      currentTags={post.data.tags || []}
      maxResults={4}
    />

    <!-- Yorum sistemi -->
    <div class="border-t pt-8">
      <h3 class="text-2xl font-bold mb-6">üí¨ Yorumlar</h3>

      <!-- Yorum formu -->
      <form id="comment-form" class="bg-gray-50 p-6 rounded-lg mb-8">
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <input
            type="text"
            id="comment-name"
            placeholder="Adƒ±nƒ±z"
            required
            class="border rounded px-3 py-2"
          />
          <input
            type="email"
            id="comment-email"
            placeholder="E-posta (gizli)"
            required
            class="border rounded px-3 py-2"
          />
        </div>
        <textarea
          id="comment-text"
          placeholder="Yorumunuzu yazƒ±n..."
          required
          rows="4"
          class="w-full border rounded px-3 py-2 mb-4"
        ></textarea>
        <button
          type="submit"
          class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors"
        >
          Yorum G√∂nder
        </button>
      </form>      <!-- Yorumlar listesi -->
      <div id="comments-list" class="space-y-4">
        <!-- Yorumlar JavaScript ile y√ºklenecek -->
      </div>
    </div>
  </article>

  <script>
    // Yorum sistemi JavaScript kodu
    const commentForm = document.getElementById('comment-form');
    const commentsList = document.getElementById('comments-list');
    const postSlug = window.location.pathname;

    // Yorumlarƒ± localStorage'dan y√ºkle
    function loadComments() {
      const comments = JSON.parse(localStorage.getItem(`comments_${postSlug}`) || '[]');
      renderComments(comments);
    }

    // Yorumlarƒ± render et
    function renderComments(comments) {
      commentsList.innerHTML = '';
      if (comments.length === 0) {
        commentsList.innerHTML = '<p class="text-gray-500 text-center">Hen√ºz yorum yapƒ±lmamƒ±≈ü. ƒ∞lk yorumu siz yapƒ±n!</p>';
        return;
      }

      comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'bg-white border rounded-lg p-4 shadow-sm';
        commentDiv.innerHTML = `
          <div class="flex items-center mb-2">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm mr-3">
              ${comment.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <span class="font-semibold">${comment.name}</span>
              <span class="text-gray-500 text-sm ml-2">${new Date(comment.date).toLocaleDateString('tr-TR')}</span>
            </div>
          </div>
          <p class="text-gray-700 ml-11">${comment.text}</p>
        `;
        commentsList.appendChild(commentDiv);
      });
    }

    // Yorum g√∂nder
    commentForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const name = document.getElementById('comment-name').value;
      const email = document.getElementById('comment-email').value;
      const text = document.getElementById('comment-text').value;

      if (!name || !email || !text) return;

      const comment = {
        name,
        email,
        text,
        date: new Date().toISOString()
      };

      const comments = JSON.parse(localStorage.getItem(`comments_${postSlug}`) || '[]');
      comments.unshift(comment);
      localStorage.setItem(`comments_${postSlug}`, JSON.stringify(comments));

      // Formu temizle
      commentForm.reset();

      // Yorumlarƒ± yeniden y√ºkle
      loadComments();

      // Ba≈üarƒ± mesajƒ±
      const successMsg = document.createElement('div');
      successMsg.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4';
      successMsg.textContent = 'Yorumunuz ba≈üarƒ±yla eklendi!';
      commentForm.insertBefore(successMsg, commentForm.firstChild);
      setTimeout(() => successMsg.remove(), 3000);
    });

    // Sayfa y√ºklendiƒüinde yorumlarƒ± y√ºkle
    loadComments();
  </script>
</Layout>
