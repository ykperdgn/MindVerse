---
import Layout from '../../components/Layout.astro';
import CTASection from '../../components/CTASection.astro';
import RelatedPosts from '../../components/RelatedPosts.astro';
import { getCollection, getEntry } from 'astro:content';

export async function getStaticPaths() {
  const categories = ['health', 'love', 'history', 'psychology', 'space', 'quotes'];
  const paths = [];

  for (const category of categories) {
    try {
      const posts = await getCollection(category);
      for (const post of posts) {
        // Sadece geÃ§erli slug'Ä± olan postlarÄ± dahil et
        if (post.slug && post.slug.trim() !== '') {
          paths.push({
            params: { category, slug: post.slug },
            props: { post }
          });
        }
      }
    } catch (error) {
      console.warn(`Error loading category ${category}:`, error);
    }
  }

  return paths;
}

const { category, slug } = Astro.params;
const { post } = Astro.props;

// Render the content
const { Content } = await post.render();
---

<Layout title={post.data.title}>
  <article class="max-w-4xl mx-auto px-4 py-8">
    <div class="mb-8">
      <span class="bg-blue-100 text-blue-800 text-sm font-semibold px-3 py-1 rounded-full capitalize">
        {category}
      </span>
      <h1 class="text-4xl font-bold mt-4 mb-4">{post.data.title}</h1>
      <p class="text-gray-600 text-lg mb-6">{post.data.summary}</p>
      <div class="flex flex-wrap gap-2 mb-6">
        {post.data.tags?.map(tag => (
          <span class="bg-gray-100 text-gray-700 text-xs px-2 py-1 rounded">#{tag}</span>
        ))}
      </div>
    </div>    <!-- AdSense reklam alanÄ± -->
    <div class="flex justify-center mb-8">
      <ins class="adsbygoogle"
        style="display: block"
        data-ad-client="ca-pub-xxxxxxxxxxxxxxxx"
        data-ad-slot="1234567890"
        data-ad-format="auto"
        data-full-width-responsive="true"></ins>
    </div>    <div class="prose prose-lg max-w-none mb-12">
      <Content />
    </div>

    <!-- CTA BÃ¶lÃ¼mÃ¼ -->
    <CTASection />

    <!-- Benzer Ä°Ã§erikler -->
    <RelatedPosts
      currentSlug={post.slug}
      currentCategory={category}
      currentTags={post.data.tags || []}
      maxResults={4}
    />

    <!-- Yorum sistemi -->
    <div class="border-t pt-8">
      <h3 class="text-2xl font-bold mb-6">ðŸ’¬ Yorumlar</h3>

      <!-- Yorum formu -->
      <form id="comment-form" class="bg-gray-50 p-6 rounded-lg mb-8">
        <div class="grid md:grid-cols-2 gap-4 mb-4">
          <input
            type="text"
            id="comment-name"
            placeholder="AdÄ±nÄ±z"
            required
            class="border rounded px-3 py-2"
          />
          <input
            type="email"
            id="comment-email"
            placeholder="E-posta (gizli)"
            required
            class="border rounded px-3 py-2"
          />
        </div>
        <textarea
          id="comment-text"
          placeholder="Yorumunuzu yazÄ±n..."
          required
          rows="4"
          class="w-full border rounded px-3 py-2 mb-4"
        ></textarea>
        <button
          type="submit"
          class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 transition-colors"
        >
          Yorum GÃ¶nder
        </button>
      </form>      <!-- Yorumlar listesi -->
      <div id="comments-list" class="space-y-4">
        <!-- Yorumlar JavaScript ile yÃ¼klenecek -->
      </div>
    </div>
  </article>

  <script>
    // Yorum sistemi JavaScript kodu
    const commentForm = document.getElementById('comment-form');
    const commentsList = document.getElementById('comments-list');
    const postSlug = window.location.pathname;

    // YorumlarÄ± localStorage'dan yÃ¼kle
    function loadComments() {
      const comments = JSON.parse(localStorage.getItem(`comments_${postSlug}`) || '[]');
      renderComments(comments);
    }

    // YorumlarÄ± render et
    function renderComments(comments) {
      commentsList.innerHTML = '';
      if (comments.length === 0) {
        commentsList.innerHTML = '<p class="text-gray-500 text-center">HenÃ¼z yorum yapÄ±lmamÄ±ÅŸ. Ä°lk yorumu siz yapÄ±n!</p>';
        return;
      }

      comments.forEach(comment => {
        const commentDiv = document.createElement('div');
        commentDiv.className = 'bg-white border rounded-lg p-4 shadow-sm';
        commentDiv.innerHTML = `
          <div class="flex items-center mb-2">
            <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center text-white font-semibold text-sm mr-3">
              ${comment.name.charAt(0).toUpperCase()}
            </div>
            <div>
              <span class="font-semibold">${comment.name}</span>
              <span class="text-gray-500 text-sm ml-2">${new Date(comment.date).toLocaleDateString('tr-TR')}</span>
            </div>
          </div>
          <p class="text-gray-700 ml-11">${comment.text}</p>
        `;
        commentsList.appendChild(commentDiv);
      });
    }

    // Yorum gÃ¶nder
    commentForm.addEventListener('submit', function(e) {
      e.preventDefault();

      const name = document.getElementById('comment-name').value;
      const email = document.getElementById('comment-email').value;
      const text = document.getElementById('comment-text').value;

      if (!name || !email || !text) return;

      const comment = {
        name,
        email,
        text,
        date: new Date().toISOString()
      };

      const comments = JSON.parse(localStorage.getItem(`comments_${postSlug}`) || '[]');
      comments.unshift(comment);
      localStorage.setItem(`comments_${postSlug}`, JSON.stringify(comments));

      // Formu temizle
      commentForm.reset();

      // YorumlarÄ± yeniden yÃ¼kle
      loadComments();

      // BaÅŸarÄ± mesajÄ±
      const successMsg = document.createElement('div');
      successMsg.className = 'bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-4';
      successMsg.textContent = 'Yorumunuz baÅŸarÄ±yla eklendi!';
      commentForm.insertBefore(successMsg, commentForm.firstChild);
      setTimeout(() => successMsg.remove(), 3000);
    });

    // Sayfa yÃ¼klendiÄŸinde yorumlarÄ± yÃ¼kle
    loadComments();
  </script>
</Layout>
